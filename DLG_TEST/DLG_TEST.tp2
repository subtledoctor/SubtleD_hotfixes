BACKUP ~DLG_TEST/backup~
AUTHOR ~SubtleD~

LANGUAGE
  ~English~
  ~english~
  ~DLG_TEST/language/en_US/setup.tra~

//do stuff__________________________________________________________________________
//
BEGIN ~DLG_TEST~

INCLUDE ~%MOD_FOLDER%/lib/misc_functions.tpa~

//PREP SPLPROT.2DA___________________________________________________________________
//
APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
APPEND ~splprot.2da~ ~D5_KIT_NOT%TAB%152%TAB%-1%TAB%5~ UNLESS ~D5_KIT_NOT~
APPEND ~splprot.2da~ ~D5_115_FEATS%TAB%115%TAB%-1%TAB%8~ UNLESS ~D5_115_FEATS~
//APPEND ~splprot.2da~ ~D5_115_NFEATS%TAB%115%TAB%-1%TAB%9~ UNLESS ~D5_115_NFEATS~

COPY_EXISTING ~splprot.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
    READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~) BEGIN
	  SET kit_is_row = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_KIT_NOT~) BEGIN
	  SET kit_not_row = %row%
	END
	PATCH_IF (~%stat%~ STRING_EQUAL_CASE ~D5_115_FEATS~) BEGIN
	  SET 115_feats_row = %row%
	END
  END
BUT_ONLY


//__________________________________________________________________________________
//
//								FIGHTING POSTURES
//__________________________________________________________________________________


//fighting postures__________________________________________________________________
//
// leadership, grapple, parry damage types, missile snaring, fighting dirty, spell evasion
//
// need to make switchable fighting postures actually work!
//
// d5csp1 = leadership
// d5csp2 = grappling
// d5csp3 = precise strike
// d5csp4 = parry slashing
// d5csp5 = parry piercing
// d5csp6 = parry blunt
// d5csp7 = missile snaring
// d5csp8 = fighting dirty
// d5csp9 = spell evasion

/*
make spell_1 with 146 effects, casting 9 206 spells
cast spell_1 when stat 115 is *
apply perm 206 vs spell_1 from... 

EDIT - no, change this to mimic the way MnG bard songs work!
...so, these are just bard songs I guess. :(
*/

OUTER_SET nada = RESOLVE_STR_REF (~ ~)

ACTION_IF !(FILE_EXISTS_IN_GAME ~7eyes.2da~) BEGIN
  COPY ~%MOD_FOLDER%/csp/7eyes.2da~ ~override~
END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5cx115.spl~					//		cancel postures
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp1a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp2a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp3a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp4a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp5a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp6a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp7a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp8a~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csp9a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp1a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp2g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp3g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp4g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp5g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp6g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp7g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp8g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp9g~ END

ACTION_FOR_EACH po_spl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ ~9~ BEGIN			//		set up posture spells
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp%po_spl%.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp2~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp3~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp4~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp5~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp6~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp7~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp8~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = ~d5csp9~ END
END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5c115b.spl~					//		206 vs. all postures
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp1b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp2b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp3b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp4b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp5b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp6b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp7b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp8b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp9b~ END

ACTION_FOR_EACH lrn_spl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ ~9~ BEGIN		//		each 206 / 171
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp%lrn_spl%b.spl~	
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5csp%lrn_spl%g~ END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = EVAL ~d5csp%lrn_spl%b~ END
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp%lrn_spl%g.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = EVAL ~d5csp%lrn_spl%~ END
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp%lrn_spl%l.spl~
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = EVAL ~d5csp%lrn_spl%b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 duration = 0 STR_VAR resource = EVAL ~d5csp%lrn_spl%b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = EVAL ~d5csp%lrn_spl%g~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~d5csp%lrn_spl%~ END

 CREATE EFF  ~d5csp%lrn_spl%~
	WRITE_LONG 0x10 187
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0xa8 ~D5CSP%lrn_spl%~ #32

END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp1.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp1.spl~			//			leadership
  SAY NAME1 @12011
  SAY UNIDENTIFIED_DESC @12012
  WRITE_ASCII 0x3a ~d5csp1~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp1a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp1a.spl~					//		leadership effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp1a~ END

CREATE EFF ~d5csp1a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5csp1b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp1b.spl~					//		leadership external
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 PROJECTILE = 158 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 2 opcode = 321 timing = 1 STR_VAR resource = ~d5csp1b~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 0 parameter1 = 1 parameter2 = 0 timing = 0 duration = 7 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 278 parameter1 = 1 parameter2 = 0 timing = 0 duration = 7 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 189 parameter1 = 1 parameter2 = 0 timing = 0 duration = 7 END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp2.bam~ ~override~

ADD_PROJECTILE ~scales_of_balance/csp/d5csp2.pro~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2.spl~			//			grappling
  SAY NAME1 @12013
  SAY UNIDENTIFIED_DESC @12014
  WRITE_ASCII 0x3a ~d5csp2~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp2~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp2a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2a.spl~					//		grappling effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp2a~ END

CREATE EFF ~d5csp2a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 2
	WRITE_LONG 0x20 7
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 126144000
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5csp2b~ #8

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2b.spl~					//		grappling effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 range = 255 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 9 parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp2c~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp2c.spl~					//		grappling effect
  LPF ALTER_SPELL_HEADER INT_VAR type = 1 target = 1 range = 3 projectile = %d5csp2% END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 45 target = 2 timing = 0 duration = 1 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 176 target = 2 parameter2 = 1 timing = 0 duration = 3 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 40 target = 2 timing = 0 duration = 6 savingthrow = 16 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 9 parameter1 = 0 parameter2 = 2 timing = 0 duration = 2 savingthrow = 16 STR_VAR resource = ~d5csp2c~ END

/*
CREATE EFF ~d5csp2c~
	WRITE_LONG 0x10 176
	WRITE_LONG 0x14 9
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 2
	WRITE_SHORT 0x2c 100
*/
CREATE EFF ~d5csp2c~
	WRITE_LONG 0x10 50
	WRITE_LONG 0x14 9
	WRITE_LONG 0x1c 26368
	WRITE_SHORT 0x20 2
	WRITE_BYTE 0x23 20
	WRITE_LONG 0x24 0
	WRITE_LONG 0x28 126144000
	WRITE_SHORT 0x2c 100

// ***** need to set up grappling like shield bash
// ...or, just mimic the Slow bard aura
// ...maybe you should be able to turn off postures? make them just like the MnG bard songs?
// ***** then these all need icons, and there needs to be a 'cancel postures' icon

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp3.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp3.spl~			//			precise strike
  SAY NAME1 @12015
  SAY UNIDENTIFIED_DESC @12016
  WRITE_ASCII 0x3a ~d5csp3~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp3~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp3a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp3a.spl~					//		precise strike effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 301 target = 1 parameter1 = 1 parameter2 = 0 timing = 0 duration = 126144000 END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp4.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp4.spl~			//			parry slashing
  SAY NAME1 @12017
  SAY UNIDENTIFIED_DESC @12018
  WRITE_ASCII 0x3a ~d5csp4~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp4~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp4a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_PARRYSLASH~ RET new_state_ind END
OUTER_SET parry_slashing_state = %new_state_ind%

APPEND ~7eyes.2da~ ~PARRY_SLASH  %parry_slashing_state%         %nada%         12*0x1000000 *           *           *            *            *          *          *          * ~ UNLESS ~PARRY_SLASH~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~PARRY_SLASH~) BEGIN
	  SET parry_slashing_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp4a.spl~					//		parry slashing effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp4a~ END

CREATE EFF  ~d5csp4a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP4b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp4b.spl~
  PATCH_IF (IS_AN_INT %parry_crushing_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %parry_slashing_state% parameter2 = %parry_slashing_row% timing = 4 duration = 0 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp4b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp5.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp5.spl~			//			parry piercing
  SAY NAME1 @12019
  SAY UNIDENTIFIED_DESC @12020
  WRITE_ASCII 0x3a ~d5csp5~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp5~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp5a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_PARRYPIERCE~ RET new_state_ind END
OUTER_SET parry_piercing_state = %new_state_ind%

APPEND ~7eyes.2da~ ~PARRY_PIERCE  %parry_piercing_state%         %nada%        12*0x100000  *           *           *            *            *          *          *          * ~ UNLESS ~PARRY_PIERCE~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~PARRY_PIERCE~) BEGIN
	  SET parry_piercing_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp5a.spl~					//		parry piercing effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp5a~ END

CREATE EFF  ~d5csp5a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5csp5b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp5b.spl~
  PATCH_IF (IS_AN_INT %parry_crushing_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %parry_piercing_state% parameter2 = %parry_piercing_row% timing = 4 duration = 0 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp5b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp6.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp6.spl~			//			parry blunt
  SAY NAME1 @12021
  SAY UNIDENTIFIED_DESC @12022
  WRITE_ASCII 0x3a ~d5csp6~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp6~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp6a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_PARRYBLUNT~ RET new_state_ind END
OUTER_SET parry_crushing_state = %new_state_ind%

APPEND ~7eyes.2da~ ~PARRY_BLUNT  %parry_crushing_state%         %nada%         12*0        *           *           *            *            *          *          *          * ~ UNLESS ~PARRY_BLUNT~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~PARRY_BLUNT~) BEGIN
	  SET parry_crushing_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp6a.spl~					//		parry blunt effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp6a~ END

CREATE EFF  ~d5csp6a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP6b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp6b.spl~
  PATCH_IF (IS_AN_INT %parry_crushing_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %parry_crushing_state% parameter2 = %parry_crushing_row% timing = 4 duration = 0 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp6b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp7.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp7.spl~			//			missile snaring
  SAY NAME1 @12023
  SAY UNIDENTIFIED_DESC @12024
  WRITE_ASCII 0x3a ~d5csp7~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp7~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp7a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

LAF d5_resolve_state STR_VAR new_state_id = ~D5_SNAREARROW~ RET new_state_ind END
OUTER_SET missile_snaring_state = %new_state_ind%

APPEND ~7eyes.2da~ ~SNARE_ARROW  %missile_snaring_state%         %nada%        12*0x800000 *           *           *            *            *          *          *          * ~ UNLESS ~SNARE_ARROW~

COPY_EXISTING ~7eyes.2da~ ~override~
  COUNT_2DA_ROWS 1 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 1 tag
	PATCH_IF (~%tag%~ STRING_EQUAL_CASE ~SNARE_ARROW~) BEGIN
	  SET missile_snaring_row = row
	END
  END
BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp7a.spl~					//		missile snaring effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 126144000 STR_VAR resource = ~d5csp7a~ END

CREATE EFF  ~d5csp7a~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 20
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP7b~ #8
	WRITE_LONG 0x48 102

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp7b.spl~
  PATCH_IF (IS_AN_INT %parry_crushing_row%) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 335 target = 1 parameter1 = %missile_snaring_state% parameter2 = %missile_snaring_row% timing = 4 duration = 0 END
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 321 target = 1 timing = 1 STR_VAR resource = ~d5csp7b~ END
  END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp8.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8.spl~			//			fighting dirty
  SAY NAME1 @12025
  SAY UNIDENTIFIED_DESC @12026
  WRITE_ASCII 0x3a ~d5csp8~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp8~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp8a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8a.spl~				//			fighting dirty effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 233 parameter1 = (4 << 24) parameter2 = (115 + (0x10000 * 1)) timing = 0 duration = 126144000 END

COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  PATCH_IF (~%SOURCE_SIZE%~ > ~0x71~) BEGIN
	READ_BYTE 0x31 prof
	PATCH_IF (%prof% = 89) || (%prof% = 90) || (%prof% = 91) || (%prof% = 92) || (%prof% = 93) || (%prof% = 94) || (%prof% = 95) || (%prof% = 96) || (%prof% = 97) || (%prof% = 98) || (%prof% = 99) || (%prof% = 100) BEGIN	// any melee weapon
	  LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 248 target = 1 timing = 2 resist_dispel = 0 STR_VAR resource = ~d5csp8b~ END
	END
  END
BUT_ONLY

CREATE EFF  ~d5csp8b~
	WRITE_LONG 0x10 232
	WRITE_LONG 0x14 2
	WRITE_LONG 0x1c 0
	WRITE_LONG 0x20 1
	WRITE_LONG 0x24 1
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~D5CSP8b~ #8

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8b.spl~					//		fighting dirty hit effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 9 parameter1 = (4 << 24) parameter2 = %115_feats_row% timing = 1 probability1 = 33 probability2 = 0 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 9 parameter1 = (4 << 24) parameter2 = %115_feats_row% timing = 1 probability1 = 66 probability2 = 34 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 9 parameter1 = (4 << 24) parameter2 = %115_feats_row% timing = 1 probability1 = 100 probability2 = 67 STR_VAR resource = ~d5csp8e~ END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8c.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
//  [blind]
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 24 target = 2 parameter2 = 1 timing = 0 duration = 2 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 74 target = 2 timing = 0 duration = 6 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 12 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8e~ END
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8d.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
//  [knockdown]
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 39 target = 2 parameter2 = 1 timing = 0 duration = 3 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 40 target = 2 timing = 0 duration = 2 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 12 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8e~ END
COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp8e.spl~
  LPF ALTER_SPELL_HEADER INT_VAR target = 1 END
//  [weakness]
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 250 target = 2 parameter1 = (0 - 5) timing = 0 duration = 6 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 24 target = 2 parameter1 = 7 parameter2 = 1 timing = 0 duration = 6 savingthrow = 2 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 6 STR_VAR resource = ~d5csp8d~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 0 duration = 12 STR_VAR resource = ~d5csp8e~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/csp/d5csp9.bam~ ~override~

COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp9.spl~			//			spell evasion
  SAY NAME1 @12027
  SAY UNIDENTIFIED_DESC @12028
  WRITE_ASCII 0x3a ~d5csp9~ #8
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5csp9~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5csp9a~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 1 STR_VAR resource = ~d5cx115~ END
IF_EXISTS BUT_ONLY

OUTER_SET optional_evade = 1
INCLUDE ~%MOD_FOLDER%/lib/spell_evasion.tpa~

ACTION_PHP_EACH evade_spells AS evadable_spell => val BEGIN
  ACTION_IF (%val% = 1) BEGIN
    LAF add_evade_spell INT_VAR evasion_spellstate = 252 evasion_save = 2 STR_VAR evade_ext = ~spl~ evade_res = EVAL ~%evadable_spell%~ evade_prefix = ~D5EV~ END
  END
END
ACTION_PHP_EACH evade_items AS evadable_item => val BEGIN
  ACTION_IF (%val% = 1) BEGIN
    LAF add_evade_spell INT_VAR evasion_spellstate = 252 evasion_save = 2 STR_VAR evade_ext = ~itm~ evade_res = EVAL ~%evadable_item%~ evade_prefix = ~D5EV~ END
  END
END

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csp9a.spl~					//		spell evasion effect
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 special = 1 parameter2 = 252 timing = 0 duration = 126144000 END

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								PHYSICAL FEATNESS
//__________________________________________________________________________________


//physical fitness___________________________________________________________________
//
// quickstride, health, toughness, intestinal fortitude, unflagging determination
//
// d5csf1 = health
// d5csf2 = toughness
// d5csf3 = resistance
// d5csf4 = quickstride
// d5csf5 = fortitude
// d5csf6 = determination
// d5csf7 = STR training
// d5csf8 = DEX training


ACTION_FOR_EACH app_spl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ ~8~ BEGIN			//		each feat

 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf%app_spl%l.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = EVAL ~d5csf%app_spl%~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~d5csf%app_spl%~ END

CREATE EFF  ~d5csf%app_spl%~
	WRITE_LONG 0x10 187
	WRITE_LONG 0x14 1
	WRITE_LONG 0x1c 1
	WRITE_LONG 0x20 0
	WRITE_LONG 0x24 9
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0xa8 ~D5CSF%app_spl%~ #32

END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf1.spl~				//			health conditioning
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 18 target = 1 parameter1 = 7 parameter2 = 0 timing = 9 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5cs~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf2.spl~				//			toughness
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 86 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 87 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 88 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 89 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf2~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf3.spl~				//			resistance
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 28 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 29 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 30 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 84 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 85 target = 1 parameter1 = 10 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf3~ END

//__________________________________________________________________________________


COPY_EXISTING ~d5csf4l.spl~ ~override~
  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 146 opcode = 171 parameter2 = 0 STR_VAR /*match_resource = ~d5csf4~*/ resource = ~d5strid~ END
BUT_ONLY

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5strid.spl~) BEGIN
 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5strid.spl~				//			quickstride
  SAY NAME1 @12195
  SAY UNIDENTIFIED_DESC @12195
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 4 duration = 1 STR_VAR resource = ~d5swalk~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 172 target = 1 timing = 1 duration = 0 STR_VAR resource = ~d5strid~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 176 parameter1 = 4 parameter2 = 0 timing = 0 duration = 126144000 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (2 << 24) parameter2 = (115 + (0x10000 * 1)) timing = 0 duration = 126144000 END

 COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5swalk.spl~				//			slowstride
  SAY NAME1 @12196
  SAY UNIDENTIFIED_DESC @12196
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 171 target = 1 timing = 4 duration = 1 STR_VAR resource = ~d5strid~ END
  LPF ADD_SPELL_CFEFFECT INT_VAR opcode = 172 target = 1 timing = 1 duration = 0 STR_VAR resource = ~d5swalk~ END
  LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5strid~ END
  PATCH_IF (FILE_EXISTS_IN_GAME ~spcl813.spl~) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~spcl813~ END
  END
  PATCH_IF (FILE_EXISTS_IN_GAME ~qdmnk02~) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~qdmnk02~ END
  END
  PATCH_IF (FILE_EXISTS_IN_GAME ~qdmnk03~) BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR target = 1 opcode = 321 timing = 1 STR_VAR resource = ~qdmnk03~ END
  END

 OUTER_SET speed_item_ind = 0
 OUTER_SPRINT $speed_boost_items(~%speed_item_ind%~) ~speed_boost_item~
 COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
	READ_BYTE 0x18 flags
	PATCH_IF (flags BOR 0b11111011 = 0b11111111) BEGIN 	//	droppable flag
  	  SET speed_boost = 0
	  READ_LONG 0x6a effectsoffset ELSE 0
	  READ_SHORT 0x70 effectscount ELSE 0
	  FOR (effcyc = 0; effcyc < effectscount; effcyc = effcyc + 1) BEGIN
		READ_SHORT (effectsoffset + (effcyc * 0x30)) opcode ELSE 0
		READ_SHORT (effectsoffset + (effcyc * 0x30)) + 0x04 param1 ELSE 0
		PATCH_IF (opcode = 126) && (param1 > 0) BEGIN
		  SET speed_boost = 1
		END
	  END
	  PATCH_IF (speed_boost = 1) BEGIN
		SPRINT $speed_boost_items(~%speed_item_ind%~) ~%SOURCE_RES%~
		SET ++speed_item_ind
	  END
	END
  END
 BUT_ONLY
 ACTION_PHP_EACH speed_boost_items AS ind => speed_item BEGIN
  COPY_EXISTING ~%speed_item%.itm~ ~override~
	LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 24) parameter2 = %115_feats_row% timing = 1 STR_VAR resource = EVAL ~d5swalk~ END
	LPF ADD_ITEM_EQEFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 2 STR_VAR resource = ~d5strid~ END
  IF_EXISTS BUT_ONLY
 END
END

//__________________________________________________________________________________

LAF d5_resolve_state STR_VAR new_state_id = ~D5_POISONEVADE~ RET new_state_ind END
OUTER_SET poison_evasion_state = %new_state_ind%

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf5.spl~				//			intestinal fortitude
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %poison_evasion_state% timing = 9 special = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf5~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5poisev.2da~) BEGIN
<<<<<<<< d5/d5poisev.2da
2DA V1.0 
RES
>>>>>>>> 
 COPY ~d5/d5poisev.2da~ ~override/d5poisev.2da~ 
 COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF fx_type = 25 BEGIN 							// poison
		PATCH_IF !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPPR722~) && !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPWI714~) BEGIN
//		  PATCH_PRINT "%SOURCE_RES% is a poison spell"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
		  END
		END
	  END
	  PATCH_IF fx_type = 12 BEGIN 							// damage (poison)
    	READ_SHORT fx_off + 0xa damage_type
		PATCH_IF damage_type = 32 BEGIN
		  PATCH_IF !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPPR722~) && !(~%SOURCE_RES%~ STRING_EQUAL_CASE ~SPWI714~) BEGIN
//			PATCH_PRINT "%SOURCE_RES% is a poison spell"
			INNER_ACTION BEGIN
			  APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
			END
		  END
		END
	  END
	  PATCH_IF fx_type = 78 BEGIN 							// disease
//		  PATCH_PRINT "%SOURCE_RES% is a disease spell"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
 BUT_ONLY
 COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF fx_type = 25 BEGIN 							// poison
//		  PATCH_PRINT "%SOURCE_RES% is a poison item"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	  PATCH_IF fx_type = 12 BEGIN 							// damage (poison)
    	READ_SHORT fx_off + 0xa damage_type
		PATCH_IF damage_type = 32 BEGIN
//			PATCH_PRINT "%SOURCE_RES% is a poison item"
			INNER_ACTION BEGIN
			  APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
			END
		END
	  END
	  PATCH_IF fx_type = 78 BEGIN 							// disease
//		  PATCH_PRINT "%SOURCE_RES% is a disease item"
		  INNER_ACTION BEGIN
			APPEND ~d5poisev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
 BUT_ONLY
 COPY_EXISTING ~d5poisev.2da~ ~override~ 
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 cols poison_evade_res
	READ_2DA_ENTRY row 1 cols poison_evade_type
	PATCH_IF (~%poison_evade_type%~ STRING_EQUAL_CASE ~spl~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%poison_evade_res%.spl~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %poison_evasion_state% evasion_save = 1 STR_VAR evade_ext = ~spl~ evade_condition = ~spellstate~ evade_res = EVAL ~%poison_evade_res%~ evade_prefix = ~D5VP~ END
	  END
	 END
	END
	PATCH_IF (~%poison_evade_type%~ STRING_EQUAL_CASE ~itm~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%poison_evade_res%.itm~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %poison_evasion_state% evasion_save = 1 STR_VAR evade_ext = ~itm~ evade_condition = ~spellstate~ evade_res = EVAL ~%poison_evade_res%~ evade_prefix = ~D5VP~ END
	  END
	 END
	END
  END
 BUT_ONLY
END	// end if not already present

//__________________________________________________________________________________

// determination: 39 Sleep, 217 PW Sleep, 109 Paralysis, 175 Hold, 24 Fear, 45 Stun, 210 PW Stun
LAF d5_resolve_state STR_VAR new_state_id = ~D5_STUNEVADE~ RET new_state_ind END
OUTER_SET stun_evasion_state = %new_state_ind%

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf6.spl~				//			unflagging determination
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 328 target = 1 parameter2 = %stun_evasion_state% timing = 9 special = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf6~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5stunev.2da~) BEGIN
 <<<<<<<< d5/d5stunev.2da
2DA V1.0 
RES
 >>>>>>>> 
 COPY ~d5/d5stunev.2da~ ~override/d5stunev.2da~ 
END
COPY_EXISTING_REGEXP GLOB ~^.+\.spl$~ ~override~
  GET_OFFSET_ARRAY ab_array SPL_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off SPL_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF (fx_type = 217) || (fx_type = 24) || (fx_type = 175) || (fx_type = 39) || (fx_type = 109) || (fx_type = 210) || (fx_type = 45) BEGIN
//		  PATCH_PRINT "%SOURCE_RES%.spl is subject to Determination"
		  INNER_ACTION BEGIN
			APPEND ~d5stunev.2da~ ~%SOURCE_RES% 	SPL~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
BUT_ONLY
COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  GET_OFFSET_ARRAY ab_array ITM_V10_HEADERS
  PHP_EACH ab_array AS int => ab_off BEGIN
	GET_OFFSET_ARRAY2 fx_array ab_off ITM_V10_HEAD_EFFECTS
	PHP_EACH fx_array AS int => fx_off BEGIN
	  READ_SHORT fx_off fx_type
	  PATCH_IF (fx_type = 217) || (fx_type = 24) || (fx_type = 175) || (fx_type = 39) || (fx_type = 109) || (fx_type = 210) || (fx_type = 45) BEGIN
//		  PATCH_PRINT "%SOURCE_RES%.itm is subject to Determination"
		  INNER_ACTION BEGIN
			APPEND ~d5stunev.2da~ ~%SOURCE_RES% 	ITM~ UNLESS ~%SOURCE_RES%~
		  END
	  END
	END
  END
BUT_ONLY
COPY_EXISTING ~d5stunev.2da~ ~override~ 
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 0 cols stun_evade_res
	READ_2DA_ENTRY row 1 cols poison_evade_type
	PATCH_IF (~%stun_evade_type%~ STRING_EQUAL_CASE ~spl~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%stun_evade_res%.spl~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %stun_evasion_state% evasion_save = 16 STR_VAR evade_ext = ~spl~ evade_condition = ~spellstate~ evade_res = EVAL ~%stun_evade_res%~ evade_prefix = ~D5VS~ END
	  END
	 END
	END
	PATCH_IF (~%stun_evade_type%~ STRING_EQUAL_CASE ~itm~) BEGIN 
	 PATCH_IF FILE_EXISTS_IN_GAME ~%stun_evade_res%.itm~ BEGIN
	  INNER_ACTION BEGIN
		LAF add_evade_spell INT_VAR evasion_spellstate = %stun_evasion_state% evasion_save = 16 STR_VAR evade_ext = ~itm~ evade_condition = ~spellstate~ evade_res = EVAL ~%stun_evade_res%~ evade_prefix = ~D5VS~ END
	  END
	 END
	END
  END
BUT_ONLY

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf7.spl~				//			strength training
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 44 target = 1 parameter1 = 1 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = 11335 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf7~ END

//__________________________________________________________________________________

COPY ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5csf8.spl~				//			agility training
  LPF ALTER_SPELL_HEADER INT_VAR target = 5 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 15 target = 1 parameter1 = 1 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 139 target = 1 parameter1 = 11336 parameter2 = 0 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 target = 1 opcode = 321 timing = 1 STR_VAR resource = ~d5csf8~ END

//__________________________________________________________________________________



//__________________________________________________________________________________
//
//								SKILL DIALOGUES
//__________________________________________________________________________________



ACTION_FOR_EACH stat IN ~115~ ~124~ ~127~ ~134~ BEGIN

 ACTION_FOR_EACH let IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ BEGIN

  COPY_EXISTING ~%MOD_FOLDER%/lib/d5_base.spl~ ~override/d5c%stat%%let%.spl~
    LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = EVAL ~d5cs%stat%~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 0 duration = 12 STR_VAR resource = EVAL ~d5cs%stat%~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 1 STR_VAR resource = EVAL ~d5cs%stat%%let%~ END

 END

 COPY ~%MOD_FOLDER%/csp/d5cs%stat%.bam~ ~override~

 CREATE EFF ~d5cs%stat%~
	WRITE_LONG 0x10 67
	WRITE_LONG 0x14 1
	WRITE_LONG 0x28 12
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5cs%stat%~ #8
	WRITE_ASCII 0x70 ~shskull~ #8

 COPY ~%MOD_FOLDER%/csp/d5_dlg.cre~ ~override/d5cs%stat%.cre~
  WRITE_EVALUATED_ASCII 0x248 ~d5cs%stat%~ #8

END

ACTION_FOR_EACH let IN ~a~ ~b~ ~c~ ~d~ ~e~ ~f~ ~g~ BEGIN

  COPY_EXISTING ~d5c115%let%.spl~ ~override~
    SAY NAME1 @12165
    SAY UNIDENTIFIED_DESC @12115
    LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5c115b~ END

  COPY_EXISTING ~d5c124%let%.spl~ ~override~
    SAY NAME1 @12174
    SAY UNIDENTIFIED_DESC @12124

  COPY_EXISTING ~d5c127%let%.spl~ ~override~
    SAY NAME1 @12177
    SAY UNIDENTIFIED_DESC @12127

  COPY_EXISTING ~d5c134%let%.spl~ ~override~
    SAY NAME1 @12184
    SAY UNIDENTIFIED_DESC @12134

END

//import dlg feat table______________________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5csdlg.2da~) BEGIN
  COPY ~%MOD_FOLDER%/csp/d5csdlg.2da~ ~override~
END
//__________________________________________________________________________________

<<<<<<<< d5/d5cs115.d
BEGIN ~D5CS115~

IF ~Global("D5CS115","GLOBAL",1)~ THEN BEGIN d5cs115
 SAY @12001
 IF ~GlobalLT("D5CSP1","LOCALS",1) GlobalGT("D5CS115A","GLOBAL",0)~ THEN REPLY @12011 GOTO d5cs115_1		//	leadership
 IF ~GlobalLT("D5CSP2","LOCALS",1) GlobalGT("D5CS115B","GLOBAL",0)~ THEN REPLY @12013 GOTO d5cs115_2		//	grappling
 IF ~GlobalLT("D5CSP3","LOCALS",1) GlobalGT("D5CS115C","GLOBAL",0)~ THEN REPLY @12015 GOTO d5cs115_3		//	precise strike
 IF ~GlobalLT("D5CSP4","LOCALS",1) GlobalGT("D5CS115D","GLOBAL",0)~ THEN REPLY @12017 GOTO d5cs115_4		//	parry slashing
 IF ~GlobalLT("D5CSP5","LOCALS",1) GlobalGT("D5CS115E","GLOBAL",0)~ THEN REPLY @12019 GOTO d5cs115_5		//	parry piercing
 IF ~GlobalLT("D5CSP6","LOCALS",1) GlobalGT("D5CS115F","GLOBAL",0)~ THEN REPLY @12021 GOTO d5cs115_6		//	parry blunt
 IF ~GlobalLT("D5CSP7","LOCALS",1) GlobalGT("D5CS115G","GLOBAL",0)~ THEN REPLY @12023 GOTO d5cs115_7		//	missile snaring
 IF ~GlobalLT("D5CSP8","LOCALS",1) GlobalGT("D5CS115H","GLOBAL",0)~ THEN REPLY @12025 GOTO d5cs115_8		//	fighting dirty
 IF ~GlobalLT("D5CSP9","LOCALS",1) GlobalGT("D5CS115I","GLOBAL",0)~ THEN REPLY @12027 GOTO d5cs115_9		//	spell evasion
END

IF ~~ THEN BEGIN d5cs115_1 											// leadership
 SAY @12012
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP1","LOCALS",1)~ DO ~ApplySpellRES("D5CSP1L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_2											// grappling
 SAY @12014
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP2","LOCALS",1)~ DO ~ApplySpellRES("D5CSP2L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_3 											// precise strike
 SAY @12016
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP3","LOCALS",1)~ DO ~ApplySpellRES("D5CSP3L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_4 											// parry slashing
 SAY @12018
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP4","LOCALS",1)~ DO ~ApplySpellRES("D5CSP4L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_5 											// parry piercing
 SAY @12020
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP5","LOCALS",1)~ DO ~ApplySpellRES("D5CSP5L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_6 											// parry blunt
 SAY @12022
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP6","LOCALS",1)~ DO ~ApplySpellRES("D5CSP6L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_7 											// missile snaring
 SAY @12024
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP7","LOCALS",1)~ DO ~ApplySpellRES("D5CSP7L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_8 											// fighting dirty
 SAY @12026
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP8","LOCALS",1)~ DO ~ApplySpellRES("D5CSP8L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
IF ~~ THEN BEGIN d5cs115_9 											// spell evasion
 SAY @12028
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSP9","LOCALS",1)~ DO ~ApplySpellRES("D5CSP9L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs115 
END
>>>>>>>>

COPY ~d5/d5cs115.d~ ~weidu_external/%MOD_FOLDER%/compile/d5cs115.d~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs115.d~

<<<<<<<< d5/d5cs115.baf
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),BERSERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),BERSERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),BERSERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END

IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),IK_BATTLERAGER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),IK_BATTLERAGER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),IK_BATTLERAGER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END

IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),c0tbm)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),c0tbm)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),c0tbm)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END

IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D2KENSAIZERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115D","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D2KENSAIZERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115E","GLOBAL",0)
	Continue()
END
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),D2KENSAIZERKER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115F","GLOBAL",0)
	Continue()
END

IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),SWASHBUCKLER)
THEN
	RESPONSE #100
	SetGlobal("D5CS115A","GLOBAL",1)
	Continue()
END

IF
	NumberOfTimesTalkedTo(0)
THEN
	RESPONSE #100
	SetGlobal("D5CS115","GLOBAL",1)
	SetNumTimesTalkedTo(1)
	ActionOverride(LastSummonerOf(Myself),StartDialogOverride("D5CS115",Myself))
END

IF
	True()
THEN
	RESPONSE #100
	SetGlobal("D5CS115","GLOBAL",0)
	SetGlobal("D5CS115A","GLOBAL",0)
	SetGlobal("D5CS115B","GLOBAL",0)
	SetGlobal("D5CS115C","GLOBAL",0)
	SetGlobal("D5CS115D","GLOBAL",0)
	SetGlobal("D5CS115E","GLOBAL",0)
	SetGlobal("D5CS115F","GLOBAL",0)
	SetGlobal("D5CS115G","GLOBAL",0)
	SetGlobal("D5CS115H","GLOBAL",0)
	SetGlobal("D5CS115I","GLOBAL",0)
	SetNumTimesTalkedTo(0)
	DestroySelf() 
END
>>>>>>>>

COPY ~d5/d5cs115.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs115.baf~

<<<<<<<< d5/d5115tmp.baf

>>>>>>>>

COPY ~d5/d5115tmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5115tmp.baf~

COPY_EXISTING ~d5csdlg.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 0; row < rows; ++row) BEGIN
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols class_name
      READ_2DA_ENTRY row 1 cols stat
      READ_2DA_ENTRY row col cols val
      PATCH_PRINT ~%class_name% - %stat% - %val%~
      PATCH_IF (~%stat%~ STRING_CONTAINS_REGEXP ~115~) = 0 BEGIN
        PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
          INNER_ACTION BEGIN
            APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5115tmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Class(LastSummonerOf(Myself),%class_name%)
THEN
	RESPONSE #100
	SetGlobal("D5CS%stat%","GLOBAL",1)
	Continue()
END
~
          END
        END
      END
    END
  END
BUT_ONLY

EXTEND_TOP ~d5cs115.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5115tmp.baf~

//__________________________________________________________________________________

<<<<<<<< d5/d5cs124.d
BEGIN ~D5CS124~

IF ~Global("D5CS124","GLOBAL",1)~ THEN BEGIN d5cs124
 SAY @12001
 IF ~GlobalLT("D5CSF1","LOCALS",1) GlobalGT("D5CS124A","GLOBAL",0)~ THEN REPLY @12031 GOTO d5cs124_1		//	health conditioning
 IF ~GlobalLT("D5CSF2","LOCALS",1) GlobalGT("D5CS124B","GLOBAL",0)~ THEN REPLY @12033 GOTO d5cs124_2		//	toughness
 IF ~GlobalLT("D5CSF3","LOCALS",1) GlobalGT("D5CS124C","GLOBAL",0)~ THEN REPLY @12035 GOTO d5cs124_3		//	resistance
 IF ~GlobalLT("D5CSF4","LOCALS",1) GlobalGT("D5CS124D","GLOBAL",0)~ THEN REPLY @12037 GOTO d5cs124_4		//	quickstride
 IF ~GlobalLT("D5CSF5","LOCALS",1) GlobalGT("D5CS124E","GLOBAL",0)~ THEN REPLY @12039 GOTO d5cs124_5		//	fortitude
 IF ~GlobalLT("D5CSF6","LOCALS",1) GlobalGT("D5CS124F","GLOBAL",0)~ THEN REPLY @12041 GOTO d5cs124_6		//	determination
 IF ~GlobalLT("D5CSF7","LOCALS",1) GlobalGT("D5CS124G","GLOBAL",0)~ THEN REPLY @12043 GOTO d5cs124_7		//	strength training
 IF ~GlobalLT("D5CSF8","LOCALS",1) GlobalGT("D5CS124H","GLOBAL",0)~ THEN REPLY @12045 GOTO d5cs124_8		//	agility training
END

IF ~~ THEN BEGIN d5cs124_1 											// health conditioning
 SAY @12032
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF1","LOCALS",1)~ DO ~ApplySpellRES("D5CSF1L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_2											// toughness
 SAY @12034
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF2","LOCALS",1)~ DO ~ApplySpellRES("D5CSF2L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_3 											// resistance
 SAY @12036
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF3","LOCALS",1)~ DO ~ApplySpellRES("D5CSF3L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_4 											// quickstride
 SAY @12038
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF4","LOCALS",1)~ DO ~ApplySpellRES("D5CSF4L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_5 											// fortitude
 SAY @12040
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF5","LOCALS",1)~ DO ~ApplySpellRES("D5CSF5L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_6 											// determination
 SAY @12042
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF6","LOCALS",1)~ DO ~ApplySpellRES("D5CSF6L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_7 											// strength training
 SAY @12044
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF7","LOCALS",1)~ DO ~ApplySpellRES("D5CSF7L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
IF ~~ THEN BEGIN d5cs124_8 											// agility training
 SAY @12046
 IF ~~ THEN REPLY @12002 DO ~IncrementGlobal("D5CSF8","LOCALS",1)~ DO ~ApplySpellRES("D5CSF8L",Myself)~ EXIT 
 IF ~~ THEN REPLY @12003 GOTO d5cs124 
END
>>>>>>>>

COPY ~d5/d5cs124.d~ ~weidu_external/%MOD_FOLDER%/compile/d5cs124.d~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs124.d~

<<<<<<<< d5/d5cs124.baf
IF
	NumberOfTimesTalkedTo(0)
THEN
	RESPONSE #100
	SetGlobal("D5CS124","GLOBAL",1)
	SetNumTimesTalkedTo(1)
	ActionOverride(LastSummonerOf(Myself),StartDialogOverride("D5CS124",Myself))
END

IF
	True()
THEN
	RESPONSE #100
	SetGlobal("D5CS124","GLOBAL",0)
	SetGlobal("D5CS124A","GLOBAL",0)
	SetGlobal("D5CS124B","GLOBAL",0)
	SetGlobal("D5CS124C","GLOBAL",0)
	SetGlobal("D5CS124D","GLOBAL",0)
	SetGlobal("D5CS124E","GLOBAL",0)
	SetGlobal("D5CS124F","GLOBAL",0)
	SetGlobal("D5CS124G","GLOBAL",0)
	SetGlobal("D5CS124H","GLOBAL",0)
	SetGlobal("D5CS124I","GLOBAL",0)
	SetNumTimesTalkedTo(0)
	DestroySelf() 
END
>>>>>>>>

COPY ~d5/d5cs124.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5cs124.baf~

COMPILE ~weidu_external/%MOD_FOLDER%/compile/d5cs124.baf~

<<<<<<<< d5/d5124tmp.baf

>>>>>>>>

COPY ~d5/d5124tmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5124tmp.baf~

COPY_EXISTING ~d5csdlg.2da~ ~override~
  COUNT_2DA_COLS cols
  COUNT_2DA_ROWS cols rows
  FOR (row = 0; row < rows; ++row) BEGIN
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols class_name
      READ_2DA_ENTRY row 1 cols stat
      READ_2DA_ENTRY row col cols val
      PATCH_PRINT ~%class_name% - %stat% - %val%~
      PATCH_IF (~%stat%~ STRING_CONTAINS_REGEXP ~124~) = 0 BEGIN
        PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
          INNER_ACTION BEGIN
            APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5124tmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Class(LastSummonerOf(Myself),%class_name%)
THEN
	RESPONSE #100
	SetGlobal("D5CS%stat%","GLOBAL",1)
	Continue()
END
~
          END
        END
      END
    END
  END
BUT_ONLY

EXTEND_TOP ~d5cs124.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5124tmp.baf~


//__________________________________________________________________________________
//
//							start skill dialogues
//__________________________________________________________________________________


APPEND ~clabfi01.2da~ 
~SKILLS      GA_D5C115A  ****        ****        
SKILLS      GA_D5C124A  ****        ****        ~

